<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Eclipse MicroProfile Metrics, practical use cases</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The J*, a blog about Java, JVM, JavaScript and Gentoo Linux">
    <meta name="author" content="Víctor Orozco">
    <meta name="keywords" content="java,jvm,javascript,gentoo,linux">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <!--link href="../../css/bootstrap.min.css" rel="stylesheet"-->
    <link href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.6/flatly/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../favicon.ico">

    <meta property="og:title" content="Eclipse MicroProfile Metrics, practical use cases">
    <meta property="og:type" content="post">
    <meta property="og:url" content="http://www.vorozco.com/blog/2018/2018-10-15-Eclipse-Metrics-Usecases.html">
    <meta property="og:site_name" content="The J*">
    <meta property="og:locale" content="en-US">
    <meta property="article:published_time" content="17 October 2018">
    <meta property="article:author" content="https://www.facebook.com/tuxtor">
    <meta property="fb:app_id" content="753735224749731">
    <meta property="og:image" content="http://vorozco.com/images/global/playground.png">

  </head>
  <body onload="prettyPrint()">
    <div id="wrap">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-41004409-2', 'auto');
      ga('send', 'pageview');

    </script>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.4&appId=290416645177";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
        <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../index.html">The J*</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../../blog">Blog</a></li>
            <li><a href="../../about.html">About</a></li>
            <li><a href="../../archive.html">Archive</a></li>
            <li><a href="../../contact.html">Contact</a></li>
            <li><a href="https://feeds.feedburner.com/the-j">Subscribe</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">
	<div class="page-header">
		<h1>Eclipse MicroProfile Metrics, practical use cases</h1>
	</div>

	<p><em>17 October 2018</em></p>

	<div class="row">

		<div class="col-md-9">
			<p><h2>Background</h2><p>At the end of 2000 decade, one of the main motivations for DevOps creation was the (relatively speaking) neglected interaction between development, QA and operations teams.</p><p>In this line, <strong>the "DevOps promise" could be resumed as a conjuction between culture, practices and tools</strong> to improve software quality and, at the same time, to speed up software development teams in terms of time to market. Winning in many successful implementations colateral effects like scalability, stability, security and development speed.</p><p>In line with divers oppinions, to implement a succesfull DevOps culture, IT teams need to implement practices like:</p>
<ul>
  <li>Continuos integration (CI)</li>
  <li>Continuos delivery (CD)</li>
  <li>MicroServices</li>
  <li>Infrastructure as code</li>
  <li>Communication and collaboration</li>
  <li><strong>Monitoring and metrics</strong></li>
</ul><p>In this world of <strong>buzzwords</strong> it's indeed difficult to identify the DevOps maturity state without losing the final goal: <strong>To create applications that generate value for the customer in short periods of time</strong>.</p><p>In this post, we will discuss about monitoring and metrics in the Java Enterprise World, specially how the new DevOps practices impact the architectural decision in the technology selection phase.</p><h2>Metrics in Java monoliths</h2><p>If traditional architectures are considered, monolithic applications hold common characteristics like:</p>
<ol>
  <li>Execution over servlet containers and application servers, with the JVM being a <strong>long running</strong> process.</li>
  <li>Ideally, these containers are never rebooted, or reboots are allowed on planified mantainance Windows.</li>
  <li>An application could compromise the integrity of the entire platform under several conditions like bad code, bad deployments and server issues.</li>
</ol><p><strong>Without considering any Java framework, the deployment structure will be simmilar to the figure</strong>. In here we observe that applications are distributed with .war or .jar files, being collected in .ear files for management purposes. In these architectures applications are created and separated considering its business objective.</p><p><img src="images/metrics/monolith.png" alt="Monolith deployment" /></p><p>If a need to scale appears, there are basically two options -i.e. to scale server resources (vertical) and to add more servers with an application copy to distribute clients using a load balancer-. It is worth to notice that new nodes tend to be also <strong>long running</strong> processes, since any application server reboot implies a considerable amount of time that is directly proportional to the quantity of applications that have been deployed.</p><p>Hence, the decision to provision (or not) a new application server often is a combined decission between development and operations teams, and with this you have the following options to monitor the state of your applications and application server:</p>
<ol>
  <li>Vendor or vendor-neutral telemetric APIs -e.g <a href="https://jolokia.org/">Jookla</a>, <a href="https://www.oracle.com/technetwork/articles/java/glassfishmm-2082439.html">Glassfish REST Metrics</a>-</li>
  <li>JMX monitorint through specific tools and ports -e.g. <a href="https://visualvm.github.io/">VisualVM</a>, <a href="https://github.com/JDKMissionControl/jmc">Mission Control</a>-</li>
  <li>"Shell wrangling" with tail, sed, cat, top and htop</li>
</ol><p>It should be noticed also, in this kind of deployments it's necessary to obtain metrics from <strong>application and server</strong>, creating a complex scenario for status monitoring.</p><p>The <em>rule of thumb</em> for this scenarios is often to choose telemetric/own APIs to monitor application state and JMX/Logs for a deeper analysis of runtime situation, again presenting more questions:</p>
<ul>
  <li>Which telemtric API should I choose? Do I need a specific format?</li>
  <li>Server's telemetry is sufficient? How metrics will be processed?</li>
  <li>How do I got access to JMX in my deployments if I'm a Containers/PaaS user?</li>
</ul><h2>Reactive applications</h2><p>En línea con la búsqueda de generación de valor para el usuario, <strong>uno de los abordajes recientes para mejorar la experiencia es el uso e implementación de sistemas reactivos</strong>, definiendo sus principios en el <a href="https://www.reactivemanifesto.org/">Reactive Manifesto</a>.</p><p><img src="images/metrics/reactive-traits.png" alt="Reactive manifesto" /></p><p>En esencia un sistema reactivo es una sistema que:</p>
<ul>
  <li>Reacciona o es dirigido por mensajes (conexiones) de nuevos clientes</li>
  <li>Presenta resiliencia, o sea es capaz de fallar con estilo/parcialmente, sin comprometer todo el sistema</li>
  <li>Es elástico lo que significa que el aprovisionamiento de recursos/copias de la aplicación se realiza de forma dinámica de acuerdo a límites previamente establecidos</li>
  <li>El resultado final, deben ser aplicaciones responsivas para el usuario</li>
</ul><p>A pesar de que no suele discutirse ampliamente, las anteriores consideraciones suelen impactar directamente a las métricas ya que con aprovisionamiento dinámico de instancias no solo se aprovisionan nuevos servidores de forma dinámica, también se eliminan de forma dinámica para reducir costos y como consecuencia: <strong>ya no existen long-running process a los cuales conectarnos con JMX</strong>.</p><h2>Métricas en arquitecturas de microservicios con Java</h2><p>Nuevamente sin importar el framework o incluso el lenguaje de programación. El estilo arquitectural reactivo coloca entre una de sus <strong>sugerencias fuertes</strong> el uso de Microservicios, especialmente para una implementación natural de resiliencia y elasticidad.</p><p>La figura a continuación describe una arquitectura tradicional basada en Microservicios:</p><p><img src="images/metrics/microservices.png" alt="Despliegue microservicios" /></p><p>Observamos que cada uno de los Microservicios no sera más que un "trabajador" sin estado que publica su disponibilidad hacia el registro de servicios. En relación a las métricas, el registro sera el origen de la configuración de un recolector de métricas que posteriormente verifica uno a uno los microservicios activos para un tiempo T y almacena los datos tanto del entorno de ejecución como de la aplicación para proveer visualizaciones en tiempo real.</p><h2>Métricas en Java EE y Eclipse MicroProfile</h2><p>A pesar de que en su momento Java EE tuvo un <a href="https://jcp.org/en/jsr/detail?id=77">API de administración que incluía algunas métricas</a>, la necesidad de un estandar de este tipo se volvió prioridad con la popularización de los microservicios. Siendo <strong>el proyecto <a href="https://metrics.dropwizard.io/3.1.0/">Dropwizard Metrics</a> uno de los pioneros para suplir la necesidad</strong> de APIs telemétricas para (micro)servicios en Java EE con las extensiones especificas para <a href="https://github.com/astefanutti/metrics-cdi">CDI</a>. </p><p>En línea con estos esfuerzos la iniciativa MicroProfile (extensiones de microservicios para Java EE) ha incluido en sus lanzamientos más recientes (1.4 y 2.0) soporte para metricas de desempeño y estado en las APIs denominadas Healthcheck y Metrics. <strong>Muchos de los usuarios actuales de DropWizard notaran que las anotaciones son similares. De hecho son las mismas ya que MicroProfile ha basado sus anotaciones en la <a href="https://microprofile.io/project/eclipse/microprofile-metrics/spec/src/main/asciidoc/app-programming-model.adoc">API 3.2.3 de DropWizard</a></strong>.</p><p>Healtcheck básicamente se encarga de responder si el servicio esta o no en ejecución y cual es su estado actual y por otro lado Metrics, las cuales presentan métricas relativas al desempeño de la aplicación</p><h2>Métricas con Payara y Eclipse MicroProfile</h2><p>Para probar la funcionalidad de cada una de las métricas utilizaremos como base una aplicación con dependencia en dos orígenes de datos, descrita en el siguiente diagrama:</p><p><img src="images/metrics/demomicro.png" alt="Arquitectura tests" /></p><p><strong>Nuestro escenario de pruebas incluye dos micro servicios, un microservicio denominado OmdbService cuyo único objetivo es conectarse hacia OMDB para obtener información de películas y MovieService cuyo objetivo es obtener la información general de una película desde una base de datos relacional y combinarla con la descripción de OMDB</strong>. El código de ambos proyectos está disponible en GitHub, (MovieService), (OmdbService).</p><p>El escenario anterior sera probado sobre Payara 5. Las últimas versiones de Payara incluyen soporte para MicroProfile 2.0 o lo que es lo mismo, soporte para Metrics 1.1 en las cuales se incluye soporte para:</p>
<ul>
  <li>Counted</li>
  <li>Gauge</li>
  <li>Timed</li>
  <li>Histogram</li>
</ul><p>Para activar el soporte a MicroProfile 2.0 incluiremos la siguiente dependencia en nuestro archivo pom.xml. Notese que el scope seleccionado es <code>provided</code> ya que la implementación esta incluida en Payara Micro.</p>
<pre><code class="xml">&lt;dependency&gt;
	&lt;groupId&gt;org.eclipse.microprofile&lt;/groupId&gt;
	&lt;artifactId&gt;microprofile&lt;/artifactId&gt;
	&lt;type&gt;pom&lt;/type&gt;
	&lt;version&gt;2.0.1&lt;/version&gt;
	&lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre><p>En MicroProfile, las métricas son expuestas en tres grandes niveles, presentando las siguientes categorías:</p>
<ol>
  <li><strong>Base:</strong> Metricas obligatorias para todos los implementadores. En este nivel cada implementador puede requerir pasos adicionales de configuración, ubicadas en <code>/metrics/base</code></li>
  <li><strong>Application:</strong> Las métricas deben ser expuestas por el programador mediante el uso de una API en Java, ubicadas en <code>/metrics/application</code></li>
  <li><strong>Vendor:</strong> No existe una implementación única y cada implementador las publica a su conveniencia, ubicadas en <code>/metrics/vendor</code></li>
</ol><p>Dependiendo el encabezado proporcionado al consumir las APIs, las mismas se exponen en formato JSON y <a href="https://openmetrics.io/">OpenMetrics</a>. Este último popularizado por Prometheus, recientemente graduado en <a href="https://www.cncf.io/announcement/2018/08/09/prometheus-graduates/">Cloud Native Computing Foundation</a>.</p><h2>Casos prácticos de uso</h2><p>Hasta este momento hemos establecido que:</p>
<ol>
  <li>Existen APIs de telémetria y arquitecturas especificas para monitorizar aplicaciones en Java</li>
  <li>Las aplicaciones reactivas establecieron nuevas necesidades al medir el estado de aplicaciones en Java</li>
  <li>JMX suene no ser la mejor opción al momento de monitorizar procesos con tiempos de vida cortos, o entornos de tipo Paas</li>
  <li>MicroProfile Metrics es una solución para entornos Java EE, sin importar si son arquitecturas tradicionales o basadas en MicroServicios</li>
</ol><p>Plantearemos entonces algunos casos y dejaremos el resto para Oracle Code One (<a href="https://oracle.rainfocus.com/widget/oracle/oow18/catalogcodeone18?search=Orozco">no se pierdan nuestra presentación</a>).</p><h3>Caso 1: Telemetría para servidores monolíticas</h3><p>Uno de los puntos más interesantes de Eclipse MicroProfile es que en si misma son extensiones de Java EE, por lo que es posible utilizar las métricas proveídas en entornos tradicionales. Por ejemplo si desplegamos unicamente el servicio de OMDB sobre Payara 5, este sera el resultado al consultar las métricas Base en el servidor de aplicaciones (<code>http://localhost:8080/metrics</code>).</p><p><img src="images/metrics/base-metrics.png" alt="Base metrics" /></p><p>Para probar la funcionalidad Base de MicroProfile, ejecutaremos peticiones http hacia</p><p><code>http://localhost:8080/omdb-demo/rest/omdb/tt0133093</code></p><p>Mediante la cual obtendremos la información de Matrix, esta API ha sido programada con un cliente JAX-RS de tipo blocking para forzar la creación de nuevos threads al momento de realizar la consulta.</p><p><img src="images/metrics/matrix.png" alt="Matrix" /></p><p>Simulando una carga hacia la aplicación mediante JMeter durante 15 minutos de prueba podemos observar que las métricas presentadas vía JMX son bastante cercanas a las presentadas por Metrics. Con lo cual consideraremos que Metrics sera una alternativa viable para casos que no involucren profiling a bajo nivel. <strong>El único inconveniente "real" al utilizar Prometheus es la necesidad de crear nuestras propias consultas</strong>.</p><h3>Caso 2: Reemplazando a JMX en MicroServicios</h3><h3>Caso 3: Identificando cuellos de botella en aplicaciones</h3><h3>Caso 4: Identificando cuellos de botella en aplicaciones</h3></p>

			<div id="share">
<!-- Twitter -->
<a href="https://twitter.com/share" class="twitter-share-button" data-dnt="true">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>


<!-- Google Plus -->
<div class="g-plusone" data-size="medium"></div>
<script type="text/javascript">
  window.___gcfg = {lang: 'en-GB'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

<!-- Facebook -->
<div
  class="fb-like"
  data-share="true"
  data-width="450"
  data-show-faces="false">
</div></div>
			
			<hr />

			<div id="disqus_thread"></div>
			<script type="text/javascript">
			    /* * * CONFIGURATION VARIABLES * * */
			    var disqus_shortname = 'opinguimacademicoq';

			    /* * * DON'T EDIT BELOW THIS LINE * * */
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

		</div>
			<div class="col-md-3">
			<form style="border:1px solid #ccc;padding:3px;text-align:center;" action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=the-j', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true"><p>Enter your email address:</p><p><input type="text" style="width:140px" name="email"/></p><input type="hidden" value="the-j" name="uri"/><input type="hidden" name="loc" value="en_US"/><input type="submit" value="Subscribe" /><p>Delivered by <a href="https://feedburner.google.com" target="_blank">FeedBurner</a></p></form>
			<hr/>
			
			<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html"><img src="/images/global/getjavasesdk-120x30.png" alt="Get Java SE SDK" border="0" width="120" height="30" /></a>

			<br/>

			<a href="http://www.gentoo.org/"><img src="//www.gentoo.org/assets/img/badges/gentoo-badge.png" alt="Gentoo" style="border:0" /></a>

			<br/>

			<a href="https://community.oracle.com/community/technology_network_community/java/java-champions">
			<img src="/images/global/jc.png" alt="Java Champions" style="border:0" />
			</a>

			<hr/>

		    <a class="twitter-timeline"  href="https://twitter.com/tuxtor" data-widget-id="633158537896722432">Tweets by @tuxtor</a>
	            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
		</div>
	</div>

	

	

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2015-2018 | Mixed with <a href="https://bootswatch.com/">Bootswatch</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a> | Licensed under the <a href="http://www.wtfpl.net/"/>WTFPL 2.0</a></p>
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../../js/jquery-1.11.1.min.js"></script>
    <script src="../../js/bootstrap.min.js"></script>
    <script src="../../js/prettify.js"></script>
    <link  href="//cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.css" rel="stylesheet"> <!-- 3 KB -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/8.7.1/lazyload.min.js"></script>
    </body>
</html>
